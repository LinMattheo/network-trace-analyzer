<!DOCTYPE html>
<html>
<head>
    <title>Trace Analyzer</title>
    <style>
        .upload-card { border: 1px solid #ccc; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; }
        #progressContainer { width: 100%; background: #eee; display: none; margin: 10px 0; }
        #progressBar { width: 0%; height: 20px; background: #4caf50; text-align: center; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f4f4f4; }
    </style>
</head>
<body>
    <div class="upload-card">
        <h2>ğŸš€ Trace æ–‡ä»¶ä¸Šä¼ åˆ†æ</h2>
        <input type="file" id="fileInput" accept=".pcap,.pcapng">
        <button onclick="uploadFile()">å¼€å§‹ä¸Šä¼ åˆ†æ</button>
        <div id="progressContainer"><div id="progressBar">0%</div></div>
        <p id="statusText">ç­‰å¾…æ“ä½œ...</p>
    </div>

    <div id="report-section" style="display:none; padding: 20px;">
        <hr>
        <h2>ğŸ“Š åˆ†ææŠ¥å‘Š</h2>
        <p>æ€»æ•°æ®åŒ…: <span id="total-pkts" style="font-weight:bold; color:blue;"></span></p>
        <table>
            <thead>
                <tr>
                    <th>æº IP</th>
                    <th>ç›®æ ‡ IP</th>
                    <th>æ¬¡æ•°</th>
                    <th>å æ¯”</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        const API_BASE = window.location.origin; 
    
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) { alert("è¯·é€‰æ‹©æ–‡ä»¶"); return; }
    
            const formData = new FormData();
            formData.append("file", file);
    
            const xhr = new XMLHttpRequest();
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            const statusText = document.getElementById('statusText'); // ç»Ÿä¸€ä½¿ç”¨è¿™ä¸ªå˜é‡å
    
            progressContainer.style.display = 'block';
    
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percent + "%";
                    progressBar.innerText = percent + "%";
                }
            };
    
            xhr.onload = () => {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.responseText);
                    console.log("1. ä¸Šä¼ æˆåŠŸï¼ŒæœåŠ¡å™¨å“åº”:", res);
    
                    // é‡ç‚¹æ£€æŸ¥åç«¯è¿”å›çš„æ˜¯ä¸æ˜¯ task_id
                    const taskId = res.task_id; 
                    
                    if (!taskId) {
                        statusText.innerText = "âŒ é”™è¯¯ï¼šåç«¯å“åº”ä¸­æ²¡æœ‰ task_id";
                        console.error("å“åº”æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘ task_id");
                        return;
                    }
    
                    // ã€å…³é”®ç‚¹ Bã€‘å˜é‡åå¿…é¡»å’Œå‰é¢å®šä¹‰çš„ä¸€è‡´
                    const statusDisplay = document.getElementById('statusText');
                    statusDisplay.innerText = "âœ… ä¸Šä¼ æˆåŠŸï¼ID: " + taskId;
                    
                    // å¯åŠ¨è½®è¯¢
                    pollResults(taskId);
                } else {
                    statusText.innerText = "âŒ ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : " + xhr.status;
                }
            };
            
            console.log("å³å°†è¯·æ±‚çš„åœ°å€:", `${API_BASE}/upload`);
            xhr.open("POST", `${API_BASE}/upload`, true);
            xhr.send(formData);
        }
    
        function pollResults(taskId) {
            const statusText = document.getElementById('statusText');
            console.log("2. å¼€å§‹è½®è¯¢ä»»åŠ¡ç»“æœ:", taskId);
    
            const timer = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/get_report/${taskId}`);
                    const result = await response.json();
                    console.log("3. è½®è¯¢çŠ¶æ€:", result.status);
    
                    if (result.status === "completed") {
                        clearInterval(timer);
                        statusText.innerText = "ğŸ‰ åˆ†æå®Œæˆï¼æ­£åœ¨æ¸²æŸ“è¡¨æ ¼...";
                        displayTable(result);
                    } else if (result.status === "error") {
                        clearInterval(timer);
                        statusText.innerText = "âŒ é”™è¯¯: " + result.message;
                    } else {
                        statusText.innerText = "â³ æ­£åœ¨åˆ†æä¸­ (Pyshark æ­£åœ¨è§£ææ•°æ®åŒ…)...";
                    }
                } catch (e) {
                    console.error("è½®è¯¢è¯·æ±‚å¤±è´¥:", e);
                }
            }, 2000);
        }
    
        function displayTable(result) {
            console.log("4. å‡†å¤‡æ¸²æŸ“æ•°æ®:", result.table_data);
            document.getElementById('report-section').style.display = 'block';
            document.getElementById('total-pkts').innerText = result.total;
            
            const tbody = document.getElementById('table-body');
            
            // ç¡®ä¿ table_data æœ‰å†…å®¹
            if (!result.table_data || result.table_data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4'>æœªå‘ç°æœ‰æ•ˆ IP æ•°æ®åŒ…</td></tr>";
                return;
            }
    
            tbody.innerHTML = result.table_data.map(row => `
                <tr>
                    <td>${row.source}</td>
                    <td>${row.destination}</td>
                    <td>${row.count}</td>
                    <td>${row.percentage}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>